<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>DiyReact学习之路 | LiuYang&#39;s blog | 探索，分享，创新——追求卓越</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="前端">
    <meta name="description" content="DiyReact的功能React的核心点：  组件（Component） Virtual Dom JSX Props &amp;amp; State  核心的渲染的Api：1ReactDOM.render(element, container[, callback]) 在不考虑性能，调试，扩展性的情况下，实现上面React的核心功能，相同Api，仅仅只需要几百行的代码。在此过程中，能真正的去理解其中的关键">
<meta name="keywords" content="前端">
<meta property="og:type" content="article">
<meta property="og:title" content="DiyReact学习之路">
<meta property="og:url" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/index.html">
<meta property="og:site_name" content="LiuYang&#39;s blog">
<meta property="og:description" content="DiyReact的功能React的核心点：  组件（Component） Virtual Dom JSX Props &amp;amp; State  核心的渲染的Api：1ReactDOM.render(element, container[, callback]) 在不考虑性能，调试，扩展性的情况下，实现上面React的核心功能，相同Api，仅仅只需要几百行的代码。在此过程中，能真正的去理解其中的关键">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/element转dom.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/JSX-element-dom.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/component-tree.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/element-instance-dom.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/diyreact-递归过程.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/idlecallback.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/fiber-tree.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/call-hierarchy.png">
<meta property="og:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/node-debug.png">
<meta property="og:updated_time" content="2018-08-21T02:33:44.931Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DiyReact学习之路">
<meta name="twitter:description" content="DiyReact的功能React的核心点：  组件（Component） Virtual Dom JSX Props &amp;amp; State  核心的渲染的Api：1ReactDOM.render(element, container[, callback]) 在不考虑性能，调试，扩展性的情况下，实现上面React的核心功能，相同Api，仅仅只需要几百行的代码。在此过程中，能真正的去理解其中的关键">
<meta name="twitter:image" content="https://handsomeliuyang.github.io/2018/08/07/DiyReact学习之路/element转dom.png">
    
        <link rel="alternate" type="application/atom+xml" title="LiuYang&#39;s blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/logo.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">刘阳</h5>
          <a href="mailto:40610243@qq.com" title="40610243@qq.com" class="mail">40610243@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                类别
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">DiyReact学习之路</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">DiyReact学习之路</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-08-07T13:15:35.000Z" itemprop="datePublished" class="page-time">
  2018-08-07
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#DiyReact的功能"><span class="post-toc-number">1.</span> <span class="post-toc-text">DiyReact的功能</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Element-Component-Dom"><span class="post-toc-number">2.</span> <span class="post-toc-text">Element,Component,Dom</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#createElement与JSX"><span class="post-toc-number">3.</span> <span class="post-toc-text">createElement与JSX</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Component"><span class="post-toc-number">4.</span> <span class="post-toc-text">Component</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Instance，reconciliation与Virtual-Dom"><span class="post-toc-number">5.</span> <span class="post-toc-text">Instance，reconciliation与Virtual Dom</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Fiber"><span class="post-toc-number">6.</span> <span class="post-toc-text">Fiber</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#发布"><span class="post-toc-number">7.</span> <span class="post-toc-text">发布</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#发布测试"><span class="post-toc-number">8.</span> <span class="post-toc-text">发布测试</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#踩过的坑"><span class="post-toc-number">9.</span> <span class="post-toc-text">踩过的坑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#单元测试"><span class="post-toc-number">9.1.</span> <span class="post-toc-text">单元测试</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#参考"><span class="post-toc-number">10.</span> <span class="post-toc-text">参考</span></a></li></ol>
        </nav>
    </aside>


<article id="post-DiyReact学习之路"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">DiyReact学习之路</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-08-07 21:15:35" datetime="2018-08-07T13:15:35.000Z"  itemprop="datePublished">2018-08-07</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="DiyReact的功能"><a href="#DiyReact的功能" class="headerlink" title="DiyReact的功能"></a>DiyReact的功能</h1><p>React的核心点：</p>
<ol>
<li>组件（Component）</li>
<li>Virtual Dom</li>
<li>JSX</li>
<li>Props &amp; State</li>
</ol>
<p>核心的渲染的Api：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ReactDOM.render(element, container[, callback])</div></pre></td></tr></table></figure></p>
<p>在不考虑性能，调试，扩展性的情况下，实现上面React的核心功能，相同Api，仅仅只需要几百行的代码。在此过程中，能真正的去理解其中的关键概念。</p>
<h1 id="Element-Component-Dom"><a href="#Element-Component-Dom" class="headerlink" title="Element,Component,Dom"></a>Element,Component,Dom</h1><p>下面是React最简单的写法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 最简单的element</span></div><div class="line"><span class="keyword">const</span> element = &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">"div"</span>,</div><div class="line">    <span class="attr">props</span>: &#123;</div><div class="line">        <span class="attr">id</span>: <span class="string">"foo"</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">diyreact.render(element, <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</div></pre></td></tr></table></figure></p>
<p>在此demo中，就是把element转化为dom显示出来。在React里，我们不直接操作Dom元素，我们操作的是Dom的抽象层即Element。</p>
<blockquote>
<p>Elements Describe the Tree</p>
<blockquote>
<p>An element is a plain object describing a component instance or DOM node and its desired properties.</p>
</blockquote>
</blockquote>
<p>即通过Element用来表示组件与Dom结点及他们的属性，整体构成一个树型结构，DiyReact.Element的定义非常的简单，如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">""</span>, <span class="comment">// 类型，可以为Dom元素，或Component类型，如Button</span></div><div class="line">    props: &#123;</div><div class="line">        <span class="attr">children</span>:[ <span class="comment">// element类型的children</span></div><div class="line">        ],</div><div class="line">        <span class="attr">xxx</span>: xxx  <span class="comment">// 此element的属性列表</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如下面的Element：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> element = &#123;</div><div class="line">  <span class="attr">type</span>: <span class="string">"div"</span>,</div><div class="line">  <span class="attr">props</span>: &#123;</div><div class="line">    <span class="attr">id</span>: <span class="string">"container"</span>,</div><div class="line">    <span class="attr">children</span>: [</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"input"</span>, <span class="attr">props</span>: &#123; <span class="attr">value</span>: <span class="string">"foo"</span>, <span class="attr">type</span>: <span class="string">"text"</span> &#125; &#125;,</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"a"</span>, <span class="attr">props</span>: &#123; <span class="attr">href</span>: <span class="string">"/bar"</span> &#125; &#125;,</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"span"</span>, <span class="attr">props</span>: &#123;&#125; &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>其所描述的Dom：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"foo"</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/element转dom.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>如上所示，render()方法就是利用Dom的Api，把Element树转换为对应的Dom树：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, parentDom</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> &#123;type, props&#125; = element;</div><div class="line"></div><div class="line">    <span class="comment">// 创建Dom的Element</span></div><div class="line">    <span class="keyword">const</span> isTextElement = type === <span class="string">"TEXT ELEMENT"</span>;</div><div class="line">    <span class="keyword">const</span> dom = isTextElement</div><div class="line">        ? <span class="built_in">document</span>.createTextNode(<span class="string">""</span>)</div><div class="line">        : <span class="built_in">document</span>.createElement(type);</div><div class="line"></div><div class="line">    <span class="comment">// 读取element里的onXXX属性，当事件处理</span></div><div class="line">    <span class="keyword">const</span> isListener = <span class="function"><span class="params">name</span> =&gt;</span> name.startsWith(<span class="string">"on"</span>);</div><div class="line">    <span class="built_in">Object</span>.keys(props).filter(isListener).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> eventType = name.toLowerCase().substring(<span class="number">2</span>);</div><div class="line">        dom.addEventListener(eventType, props[name]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// element里除onXXX与children属性外，都当属性对待</span></div><div class="line">    <span class="keyword">const</span> isAttribute = <span class="function"><span class="params">name</span> =&gt;</span> !isListener(name) &amp;&amp; name != <span class="string">"children"</span>;</div><div class="line">    <span class="built_in">Object</span>.keys(props).filter(isAttribute).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</div><div class="line">        dom[name] = props[name];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// 递归render children</span></div><div class="line">    <span class="keyword">const</span> childElements = props.children || [];</div><div class="line">    childElements.forEach(<span class="function"><span class="params">childElement</span> =&gt;</span> render(childElement, dom));</div><div class="line"></div><div class="line">    <span class="comment">// 添加到parentDom</span></div><div class="line">    parentDom.appendChild(dom);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="createElement与JSX"><a href="#createElement与JSX" class="headerlink" title="createElement与JSX"></a>createElement与JSX</h1><p>直接使用Element来描述Dom元素，其可读性很差，如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> element = &#123;</div><div class="line">  <span class="attr">type</span>: <span class="string">"div"</span>,</div><div class="line">  <span class="attr">props</span>: &#123;</div><div class="line">    <span class="attr">id</span>: <span class="string">"container"</span>,</div><div class="line">    <span class="attr">children</span>: [</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"input"</span>, <span class="attr">props</span>: &#123; <span class="attr">value</span>: <span class="string">"foo"</span>, <span class="attr">type</span>: <span class="string">"text"</span> &#125; &#125;,</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"a"</span>, <span class="attr">props</span>: &#123; <span class="attr">href</span>: <span class="string">"/bar"</span> children: [&#123; <span class="attr">type</span>: <span class="string">"TEXT ELEMENT"</span>, <span class="attr">props</span>: &#123; <span class="attr">nodeValue</span>: <span class="string">"bar"</span> &#125; &#125;]&#125; &#125;,</div><div class="line">      &#123; <span class="attr">type</span>: <span class="string">"span"</span>, <span class="attr">props</span>: &#123;&#125; &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>而使用JSX来表示的话，可读性就能提升很多，如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**@jsx diyreact.createElement **/</span></div><div class="line"><span class="keyword">const</span> element = (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"foo"</span> <span class="attr">type</span>=<span class="string">"text"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/bar"</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>以上的JSX语法，浏览器无法识别，需要通过babel进行预处理，通过babel的插件transform-react-jsx把JSX转换为如下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**@jsx diyreact.createElement **/</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> element = diyreact.createElement(</div><div class="line">    <span class="string">"div"</span>,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"container"</span> &#125;,</div><div class="line">    diyreact.createElement(<span class="string">"input"</span>, &#123; <span class="attr">value</span>: <span class="string">"foo"</span>, <span class="attr">type</span>: <span class="string">"text"</span> &#125;),</div><div class="line">    diyreact.createElement(</div><div class="line">        <span class="string">"a"</span>,</div><div class="line">        &#123; <span class="attr">href</span>: <span class="string">"/bar"</span> &#125;,</div><div class="line">        <span class="string">"bar"</span></div><div class="line">    ),</div><div class="line">    diyreact.createElement(<span class="string">"span"</span>, <span class="literal">null</span>)</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>增加JSX后的整体流程如下所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/JSX-element-dom.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>对应的createElement代码，非常简单：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> TEXT_ELEMENT = <span class="string">"TEXT ELEMENT"</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...args</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> props = <span class="built_in">Object</span>.assign(&#123;&#125;, config);</div><div class="line">    <span class="keyword">const</span> hasChildren = args.length &gt; <span class="number">0</span>;</div><div class="line">    <span class="keyword">const</span> rawChildren = hasChildren ? [].concat(...args) : [];</div><div class="line">    props.children = rawChildren</div><div class="line">        .filter(<span class="function"><span class="params">c</span> =&gt;</span> c != <span class="literal">null</span> &amp;&amp; c !== <span class="literal">false</span>)</div><div class="line">        .map(<span class="function"><span class="params">c</span> =&gt;</span> c <span class="keyword">instanceof</span> <span class="built_in">Object</span> ? c : createTextElement(c));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; type, props &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTextElement</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> createElement(TEXT_ELEMENT, &#123; <span class="attr">nodeValue</span>: value &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>babel的插件transform-react-jsx的做的非常通用，通用注解，可以修改默认的React.createElement函数，可以通过<a href="http://babeljs.io/en/repl" target="_blank" rel="noopener">babel-online</a>测试</p>
<p>// TODO-ly render()每次都是从root结点开始进行对比，setState()是从哪个当前这个结点开始，但整体逻辑是一样的</p>
<h1 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h1><p>React.render()函数里的element的范围很广，可以是Object，Function，Component，但只有Component才会有相应的lifecycle, states等等。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">this</span>.props = props;</div><div class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.state || &#123;&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  setState(partialState) &#123;</div><div class="line">    <span class="comment">// 更新逻辑</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多细节大家可以查看：<a href="https://engineering.hexacta.com/didact-components-and-state-53ab4c900e37" target="_blank" rel="noopener">Didact: Components and State</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** @jsx diyreact.createElement **/</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">diyreact</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></div><div class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>DiyReact的学习过程<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">diyreact.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById("root"));</span></div></pre></td></tr></table></figure>
<p>其把JSX转换后的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** @jsx diyreact.createElement **/</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">diyreact</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> diyreact.createElement(</div><div class="line">            <span class="string">"div"</span>,</div><div class="line">            <span class="literal">null</span>,</div><div class="line">            diyreact.createElement(</div><div class="line">                <span class="string">"h1"</span>,</div><div class="line">                <span class="literal">null</span>,</div><div class="line">                <span class="string">"DiyReact\u7684\u5B66\u4E60\u8FC7\u7A0B"</span></div><div class="line">            )</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">diyreact.render(diyreact.createElement(App, <span class="literal">null</span>), <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</div></pre></td></tr></table></figure></p>
<p>其对应的Element Tree与Virtual Dom Tree:<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/component-tree.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<h1 id="Instance，reconciliation与Virtual-Dom"><a href="#Instance，reconciliation与Virtual-Dom" class="headerlink" title="Instance，reconciliation与Virtual Dom"></a>Instance，reconciliation与Virtual Dom</h1><p>上述的render()函数，把element转为Dom元素，每次调用render()函数时，都会创建全新的dom元素，即使用element完全一致，都不会进行复用。如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</div><div class="line">render(element, <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</div><div class="line">render(element, <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</div></pre></td></tr></table></figure></p>
<p>在React里，求两个Elements Tree的过程称为”reconciliation“，为了复用与对比，我们需要保存一个与之对应的对象树：A Virtual Dom。</p>
<p>这个Virtual Dom的”nodes”应该是什么对象？由于如下原因，我们无法复用element对象：</p>
<ol>
<li>此node对象，需要关联其对应的dom对象，但elements树应该是不可变的</li>
<li>无法支持Component，因为每个Component都有自己的state对象</li>
</ol>
<p>引入React的新概念：Instances。此Instances就表示这个Virtual Dom Tree，其中instance表示已经render到dom的对象。定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">instance = &#123;element, dom, childInstances&#125;;</div></pre></td></tr></table></figure></p>
<p>每个element，每个Dom节点都对应一个instance对象，我们的目标是尽可能的减少此instances的创建与销毁。</p>
<p>Element，Instances，Dom的关系图：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/element-instance-dom.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>Component的setState()更新：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; reconcile &#125; <span class="keyword">from</span> <span class="string">"./reconciler"</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(props) &#123;</div><div class="line">        <span class="keyword">this</span>.props = props;</div><div class="line">        <span class="keyword">this</span>.state = <span class="keyword">this</span>.state || &#123;&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setState(partialState) &#123;</div><div class="line">        <span class="keyword">this</span>.state = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="keyword">this</span>.state, partialState);</div><div class="line">        updateInstance(<span class="keyword">this</span>.__internalInstance);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateInstance</span>(<span class="params">internalInstance</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> parentDom = internalInstance.dom.parentNode;</div><div class="line">    <span class="keyword">const</span> element = internalInstance.element;</div><div class="line">    reconcile(parentDom, internalInstance, element);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPublicInstance</span>(<span class="params">element, internalInstance</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> &#123; type, props &#125; = element;</div><div class="line">    <span class="keyword">const</span> publicInstance = <span class="keyword">new</span> type(props);</div><div class="line">    publicInstance.__internalInstance = internalInstance;</div><div class="line">    <span class="keyword">return</span> publicInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>render的核心代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> rootInstance = <span class="literal">null</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> prevInstance = rootInstance;</div><div class="line">    <span class="keyword">const</span> nextInstance = reconcile(container, prevInstance, element);</div><div class="line">    rootInstance = nextInstance;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reconcile</span>(<span class="params">parentDom, instance, element</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</div><div class="line">        <span class="comment">// Create instance</span></div><div class="line">        <span class="keyword">const</span> newInstance = instantiate(element);</div><div class="line">        parentDom.appendChild(newInstance.dom);</div><div class="line">        <span class="keyword">return</span> newInstance;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element == <span class="literal">null</span>) &#123;</div><div class="line">        <span class="comment">// Remove instance</span></div><div class="line">        parentDom.removeChild(instance.dom);</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance.element.type !== element.type) &#123;</div><div class="line">        <span class="comment">// Replace instance</span></div><div class="line">        <span class="keyword">const</span> newInstance = instantiate(element);</div><div class="line">        parentDom.replaceChild(newInstance.dom, instance.dom);</div><div class="line">        <span class="keyword">return</span> newInstance;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> element.type === <span class="string">"string"</span>) &#123;</div><div class="line">        <span class="comment">// Update dom instance</span></div><div class="line">        updateDomProperties(instance.dom, instance.element.props, element.props);</div><div class="line">        instance.childInstances = reconcileChildren(instance, element);</div><div class="line">        instance.element = element;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//Update composite instance</span></div><div class="line">        instance.publicInstance.props = element.props;</div><div class="line">        <span class="keyword">const</span> childElement = instance.publicInstance.render();</div><div class="line">        <span class="keyword">const</span> oldChildInstance = instance.childInstance;</div><div class="line">        <span class="keyword">const</span> childInstance = reconcile(parentDom, oldChildInstance, childElement);</div><div class="line">        instance.dom = childInstance.dom;</div><div class="line">        instance.childInstance = childInstance;</div><div class="line">        instance.element = element;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params">instance, element</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> dom = instance.dom;</div><div class="line">    <span class="keyword">const</span> childInstances = instance.childInstances;</div><div class="line">    <span class="keyword">const</span> nextChildElements = element.props.children || [];</div><div class="line">    <span class="keyword">const</span> newChildInstances = [];</div><div class="line">    <span class="keyword">const</span> count = <span class="built_in">Math</span>.max(childInstances.length, nextChildElements.length);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">const</span> childInstance = childInstances[i];</div><div class="line">        <span class="keyword">const</span> childElement = nextChildElements[i];</div><div class="line">        <span class="keyword">const</span> newChildInstance = reconcile(dom, childInstance, childElement);</div><div class="line">        newChildInstances.push(newChildInstance);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> newChildInstances.filter(<span class="function"><span class="params">instance</span> =&gt;</span> instance != <span class="literal">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">instantiate</span>(<span class="params">element</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> &#123; type, props &#125; = element;</div><div class="line">    <span class="keyword">const</span> isDomElement = <span class="keyword">typeof</span> type === <span class="string">"string"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isDomElement) &#123;</div><div class="line">        <span class="comment">// Instantiate DOM element</span></div><div class="line">        <span class="keyword">const</span> isTextElement = type === TEXT_ELEMENT;</div><div class="line">        <span class="keyword">const</span> dom = isTextElement</div><div class="line">            ? <span class="built_in">document</span>.createTextNode(<span class="string">""</span>)</div><div class="line">            : <span class="built_in">document</span>.createElement(type);</div><div class="line"></div><div class="line">        updateDomProperties(dom, [], props);</div><div class="line"></div><div class="line">        <span class="keyword">const</span> childElements = props.children || [];</div><div class="line">        <span class="keyword">const</span> childInstances = childElements.map(instantiate);</div><div class="line">        <span class="keyword">const</span> childDoms = childInstances.map(<span class="function"><span class="params">childInstance</span> =&gt;</span> childInstance.dom);</div><div class="line">        childDoms.forEach(<span class="function"><span class="params">childDom</span> =&gt;</span> dom.appendChild(childDom));</div><div class="line"></div><div class="line">        <span class="keyword">const</span> instance = &#123; dom, element, childInstances &#125;;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Instantiate component element</span></div><div class="line">        <span class="keyword">const</span> instance = &#123;&#125;;</div><div class="line">        <span class="keyword">const</span> publicInstance = createPublicInstance(element, instance);</div><div class="line">        <span class="keyword">const</span> childElement = publicInstance.render();</div><div class="line">        <span class="keyword">const</span> childInstance = instantiate(childElement);</div><div class="line">        <span class="keyword">const</span> dom = childInstance.dom;</div><div class="line"></div><div class="line">        <span class="built_in">Object</span>.assign(instance, &#123; dom, element, childInstance, publicInstance &#125;);</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>diyreact的reconciliation算法比较简单，只有当position与type都相同的情况下，才复用此instance，更新其内部的属性</p>
<h1 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h1><p>上述的reconciliation算法是一个递归算法，当节点数量很大时，整体执行时间比较慢，会一直占用浏览器的main thread，导致动画出现卡顿和用户操作响应不及时。卡顿的理解与Android的卡顿理解是一至的，当一次render()或setState()，触发的reconcile()过程，超过16ms时，就会出现丢帧现象。<a href="https://pomber.github.io/incremental-rendering-demo/react-sync.html" target="_blank" rel="noopener">卡顿demo</a>，如下图所示：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/diyreact-递归过程.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure></p>
<p>要解决卡顿问题，主要是解决上述的递归调用问题，让递归调用可以被中断，优先去处理animation和UI responsive。</p>
<p>React在16.x.x的解决方案是：把上述的执行过程拆分为很多的工作单元（UnitOfWork），这些很小的工作单元都能在很短的时间内执行完成，同时每两个执工作单元之间可以被中断，让main thread执行更高优先级的任务，如animation，ui responsive。</p>
<p>在DiyReact里的UnitOfWork就是包括当前节点的处理工作：</p>
<ol>
<li>new_type != cur_type：全新创建instance</li>
<li>type相等 &amp;&amp; type是string类型：更新属性</li>
<li>type相等 &amp;&amp; type为对象：执行component.render()，更新属性</li>
</ol>
<p>如果知道当前main thread需要执行更高优先级任务了？利用<a href="http://www.zhangyunling.com/702.html" target="_blank" rel="noopener">requestIdleCallback-后台任务调度</a>就可以了解当前main thread是否处于空闲时间，其调用代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">render()&#123;</div><div class="line">    updateQueue.push(...);</div><div class="line">    <span class="built_in">window</span>.requestIdleCallback(performWork);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">deadline</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">while</span>(nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME)&#123;</div><div class="line">        nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/idlecallback.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>该图中的frame#1，frame#2就是两个帧，每个帧的持续时间是(100/60 = 16.66ms)，而在每一帧内部，TASK和redering只花费了一部分时间，并没有占据整个帧，那么这个时候，如图中idle period的部分就是空闲时间，而每一帧中的空闲时间，根据该帧中处理事情的多少，复杂度等，消耗不等，所以空闲时间也不等。</p>
<p>通过deadline.timeRemaining()函数即可知道当前还剩多少idle时间。</p>
</blockquote>
<p>要实现这套新的工作单元调度，instance tree的节点instance的结构会要发生变化，如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">tag</span>:HOST_COMPONENT|CLASS_COMPONENT,</div><div class="line">    <span class="attr">type</span>:<span class="string">"div"</span>|Component,</div><div class="line">    <span class="comment">// 构建一个树型链表结构</span></div><div class="line">    parent: parentFiber,</div><div class="line">    <span class="attr">child</span>: childFiber,</div><div class="line">    <span class="attr">sibling</span>:<span class="literal">null</span>,</div><div class="line">    <span class="comment">// 关联第二颗树</span></div><div class="line">    alternate: other fiber tree,</div><div class="line">    <span class="attr">stateNode</span>:dom|component,</div><div class="line">    <span class="attr">props</span>: element.props,</div><div class="line">    <span class="attr">partialState</span>: component changed state,</div><div class="line">    <span class="comment">// 记录真正变动的节点fiber</span></div><div class="line">    effectTag:PLACEMENT,</div><div class="line">    <span class="attr">effects</span>: []</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这颗新的树的结点有一个新的名称：Fiber。这个颗也被称为Fiber Tree。</p>
<p>fiber tree的结构：</p>
<blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/fiber-tree.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
</blockquote>
<p>每两个工作单元之间，可以被更高优先级的任务中断，那就无法使用一颗Fiber Tree，即对应当前的Dom，又进行更新操作。通过上面的alternate可知，有两颗相互关联的Fiber Tree：</p>
<ol>
<li>current tree：与当前的Dom对应，其内容已经渲染到Dom上</li>
<li>work-in-progress：由render()或setState()触发的构建树</li>
</ol>
<p>方法的调用队列：</p>
<blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/2018/08/07/DiyReact学习之路/call-hierarchy.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
</blockquote>
<p>更多代码细节，请学习：<a href="https://engineering.hexacta.com/didact-fiber-incremental-reconciliation-b2fe028dcaec" target="_blank" rel="noopener">Didact Fiber: Incremental reconciliation</a></p>
<h1 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h1><p>在React的最新版本里，打包工具从webpack，改为rollup。</p>
<p>webpack与rollup基本相同，记住如下差异点：</p>
<ol>
<li>webpack支持code-splitting，同时支持按需加载</li>
<li>Rollup默认基于ES2015模块，把所有的资源放在一起，一次性加载</li>
</ol>
<p>如何选择？结论：</p>
<blockquote>
<p>针对app级别的应该使用Webpack，针对js库级别的应用应该使用Rollup。</p>
<p>更多请参考：<a href="https://www.w3ctech.com/topic/1996" target="_blank" rel="noopener">Webpack、Rollup相爱相杀的那些事</a></p>
</blockquote>
<p>rollup由于默认基于ES2015模块与语法，而整体DiyReact也是基于ES6开发的，所以配置很简单：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"build:main"</span>: <span class="string">"rollup src/diyreact.js -f umd -n diyreact -o dist/diyreact.umd.js"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>具体参数的含义请参考：<a href="https://rollupjs.org/guide/en#command-line-flags" target="_blank" rel="noopener">Command line flags</a></li>
<li>Type of output (amd, cjs, esm, iife, umd)的理解：<ol>
<li>iife: 立即执行函数</li>
<li>cjs: 遵循CommonJs Module规范的文件输出</li>
<li>amd: 遵循AMD Module规范的文件输出</li>
<li>umd: 支持外链/CommonJs Module/AMD Module规范的文件输出</li>
<li>esm: 将多个遵循ES6 Module的文件编译成1个ES6 Module</li>
</ol>
</li>
<li>在不同场景下的使用情况： <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// For browsers:</span></div><div class="line">$ rollup main.js --file bundle.js --format iife</div><div class="line"></div><div class="line"><span class="comment">// For Node.js:</span></div><div class="line">$ rollup main.js --file bundle.js --format cjs</div><div class="line"></div><div class="line"><span class="comment">// For both browsers and Node.js:</span></div><div class="line">$ rollup main.js --file bundle.js --format umd --name <span class="string">"myBundle"</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="发布测试"><a href="#发布测试" class="headerlink" title="发布测试"></a>发布测试</h1><p>为了方便测试生成后的diyreact.js文件，使用的是babel-standalone@6库，在browser下直接运行ES6语法，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;script src=&quot;https://unpkg.com/babel-standalone@6/babel.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=&quot;../dist/diyreact.umd.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</div><div class="line">    &lt;script type=&quot;text/babel&quot; data-plugins=&quot;transform-react-jsx&quot; data-presets=&quot;es2017,stage-3&quot;&gt;</div><div class="line">        /** @jsx diyreact.createElement **/</div><div class="line"></div><div class="line">        const studies = [</div><div class="line">            &#123; name: &quot;DiyReact的功能&quot;, url: &quot;https://handsomeliuyang.github.io/&quot; &#125;,</div><div class="line">            &#123; name: &quot;createElement与JSX&quot;, url: &quot;https://handsomeliuyang.github.io/&quot; &#125;,</div><div class="line">            &#123; name: &quot;Instance，reconciliation与Virtual Dom&quot;, url: &quot;https://handsomeliuyang.github.io/&quot; &#125;,</div><div class="line">            &#123; name: &quot;Component and State&quot;, url: &quot;https://handsomeliuyang.github.io/&quot; &#125;,</div><div class="line">            &#123; name: &quot;Fiber&quot;, url: &quot;https://handsomeliuyang.github.io/&quot; &#125;</div><div class="line">        ];</div><div class="line"></div><div class="line">        class App extends diyreact.Component &#123;</div><div class="line">            render() &#123;</div><div class="line">                return (</div><div class="line">                    &lt;div&gt;</div><div class="line">                        &lt;h1&gt;DiyReact的学习过程&lt;/h1&gt;</div><div class="line">                        &lt;ul&gt;</div><div class="line">                            &#123;</div><div class="line">                                this.props.studies.map(study =&gt; &#123;</div><div class="line">                                    return &lt;Study name=&#123;study.name&#125; url=&#123;study.url&#125;/&gt;;</div><div class="line">                                &#125;)</div><div class="line">                            &#125;</div><div class="line">                        &lt;/ul&gt;</div><div class="line">                    &lt;/div&gt;</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        class Study extends diyreact.Component &#123;</div><div class="line">            constructor(props) &#123;</div><div class="line">                super(props);</div><div class="line">                this.state = &#123; likes: Math.ceil(Math.random() * 100) &#125;;</div><div class="line">            &#125;</div><div class="line">            like() &#123;</div><div class="line">                this.setState(&#123;</div><div class="line">                    likes: this.state.likes + 1</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            render() &#123;</div><div class="line">                const &#123; name, url &#125; = this.props;</div><div class="line">                const &#123; likes &#125; = this.state;</div><div class="line">                const likesElement = &lt;span /&gt;;</div><div class="line">                return (</div><div class="line">                    &lt;li&gt;</div><div class="line">                        &lt;button onClick=&#123;e =&gt; this.like()&#125;&gt;赞：&#123;likes&#125;️&lt;/button&gt;</div><div class="line">                        &lt;a href=&#123;url&#125;&gt;&#123;name&#125;&lt;/a&gt;</div><div class="line">                    &lt;/li&gt;</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        diyreact.render(&lt;App studies=&#123;studies&#125; /&gt;, document.getElementById(&quot;root&quot;));</div><div class="line"></div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>注意：</p>
<ol>
<li>babel-standalone的配置API很少，可以查看其源码：<a href="https://github.com/babel/babel-standalone/blob/master/src/index.js" target="_blank" rel="noopener">https://github.com/babel/babel-standalone/blob/master/src/index.js</a></li>
<li>babel-standalone不支持env preset，只有es2015, es2016, es2017等等presets,为了支持new Class语法，需要使用es2017</li>
</ol>
<h1 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h1><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>单元测试必要性这里就不叙述了，选择的是ava单元测试框架，使用过程中的一些问题：</p>
<ol>
<li><p>es6语法，jsx语法默认不支持？<br> ava只是一个单元测试框架，需要通过babel来支持es6，jsx等语法的支持，配置如下：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="string">"ava"</span>: &#123;</div><div class="line">    <span class="string">"require"</span>: <span class="string">"babel-register"</span>,</div><div class="line">    <span class="string">"babel"</span>: <span class="string">"inherit"</span> <span class="comment">// 继承在package.json里的babel配置</span></div><div class="line">&#125;,</div><div class="line"><span class="string">"babel"</span>: &#123;</div><div class="line">    <span class="string">"plugins"</span>: [</div><div class="line">        [</div><div class="line">            <span class="string">"transform-react-jsx"</span>,</div><div class="line">            &#123;&#125;</div><div class="line">        ]</div><div class="line">    ],</div><div class="line">    <span class="string">"presets"</span>: [</div><div class="line">        [</div><div class="line">            <span class="string">"env"</span>,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"targets"</span>: &#123;</div><div class="line">                    <span class="string">"node"</span>: <span class="string">"current"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>没有browser相关的环境与Api？<br> 通过browser-env库，可以实现能browser的部分Api进行模拟，如下所示：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> browserEnv <span class="keyword">from</span> <span class="string">'browser-env'</span>;</div><div class="line">browserEnv([<span class="string">'document'</span>]);</div><div class="line">test.beforeEach(<span class="function"><span class="params">t</span>=&gt;</span>&#123;</div><div class="line">    <span class="keyword">let</span> root = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</div><div class="line">    <span class="keyword">if</span>(!root)&#123;</div><div class="line">        root = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">        root.id = <span class="string">"root"</span>;</div><div class="line">        <span class="built_in">document</span>.body.appendChild(root);</div><div class="line">    &#125;</div><div class="line">    t.context.root = root;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>browser-env库没有window.requestIdleCallback等Api？<br> 为了能进行单元测试，手动给window对象注入requestIdleCallback()实现，当然这里是假实现，如下所示：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.requestIdleCallback = <span class="function"><span class="keyword">function</span>(<span class="params">task</span>)</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">timeRemaining</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">    task(&#123;</div><div class="line">        <span class="attr">timeRemaining</span> : timeRemaining</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>ava单元测试如何debug？<br> 升级IntelliJ IDEA到新版本后，在package.json下添加的script里，添加字符串”$NODE_DEBUG_OPTION”，如下所示：<br> <img src="/2018/08/07/DiyReact学习之路/node-debug.png" alt=""></p>
</li>
<li><p>babel的一些概念理解：babel-register？babel-standalone@6？plugin与preset的区别？  </p>
<ol>
<li>babel的编译过程：<ol>
<li>parser：通过 babylon 解析成 AST</li>
<li>transform[s]：All the plugins/presets ，进一步的做语法等自定义的转译，仍然是 AST。</li>
<li>generator： 最后通过 babel-generator 生成 output string。</li>
</ol>
</li>
<li>plugins与presets的区别：presets是一个plugin的集合，如babel-preset-env，根据当前的运行环境，确定需要的plugin组合</li>
<li>babel-register：require(‘babel-register’)后，所以require()其他模块时，就会进行文件编译，这个比较适合开发期间使用</li>
<li>babel-standalone@6：在browser上，对js代码实现在线转换，要完全支持React，需要配置对应的plugins和presets，如下所示：<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/babel-standalone@6/babel.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span> <span class="attr">data-plugins</span>=<span class="string">"transform-react-jsx"</span> <span class="attr">data-presets</span>=<span class="string">"es2017,stage-3"</span>&gt;</span><span class="javascript"></span></div><div class="line">        <span class="comment">// react代码</span></div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>CommonJS与ES6模块的区别？<br>  详细请查看：<a href="https://wmaqingbo.github.io/blog/2017/09/15/ES6%E6%A8%A1%E5%9D%97-%E5%92%8C-CommonJS-%E7%9A%84%E5%8C%BA%E5%88%AB/" target="_blank" rel="noopener">ES6模块 和 CommonJS 的区别</a></p>
</li>
</ol>
<p>本篇文章的code：<a href="https://github.com/handsomeliuyang/diyreact" target="_blank" rel="noopener">diyreact</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5" target="_blank" rel="noopener">Didact: a DIY guide to build your own React</a></li>
<li><a href="https://reactjs.org/blog/2015/12/18/react-components-elements-and-instances.html" target="_blank" rel="noopener">React Components, Elements, and Instances</a></li>
<li><a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="noopener">React Fiber Architecture</a></li>
<li><a href="http://www.zhangyunling.com/702.html" target="_blank" rel="noopener">requestIdleCallback-后台任务调度</a></li>
<li><a href="https://github.com/sunyongjian/blog/issues/30" target="_blank" rel="noopener">babel的关键概念理解</a></li>
</ol>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-08-21T02:33:44.931Z" itemprop="dateUpdated">2018-08-21 10:33:44</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://handsomeliuyang.github.io">
            <img src="/img/logo.png" alt="刘阳">
            刘阳
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="二维码">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/10/30/Flutter实现Git权限分配工具之旅/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Flutter实现Git权限分配工具之旅</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/06/07/MPVue源码分析/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">MPVue源码分析</h4>
      </a>
    </div>
  
</nav>



    














</article>



</div>

        <footer class="footer">
    <div class="top">
        <!--
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>

-->
        <p>
            <!--
            <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            -->
            <span>Hi, I'm LiuYang. For now I'm an Android Programmer in 58. This is my blog, believe it or not.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>刘阳 &copy; 2017 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="二维码">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACrklEQVR42u3ay27jMBAEQP//T2evC2St7eZw8gBKJyOR5SkeSKqHr1d8ffx1vfvv850fn653f3++XhsXHh4e3qD0pIjPpGfq3SfkNePh4eFt8/KfaRePfIpPnpDXjIeHh/e7eAlg8kw8PDy838Vro4T50/LhxsPDw/tKXv7o9rtn2+V3dy5mLXh4eHgLXaSf83mlv4eHh4c37qrPg4O2oGdMXS0eHh7eAm8S0bZb4bPp/kITDg8PD2+rvx9NxM93PkcG7XZ5PqB4eHh4e7y84ZQPQbt1TgA5rz59gIeHhxfzclLOqEc3Hqy6Njw8PLxv4t3aNEeRQTBk+V/w8PDwtnltYylB5hN9vsUvlgc8PDy8ZV4bTLTI/LvP7Lqzh4eHh3eV1zaiJrz5YnNWIR4eHt5dXntcIJ/K28ZY+4Qk8sDDw8Pb450VOmlr5c9p22D/WBjw8PDw1nj5RnaybOTRbRsEF/09PDw8vDFvfmRq3iqLUpN2z4yHh4e3wJtM4pMmVj5wxRGrpMuHh4eHd4mXN5byqHc+WMnwJW05PDw8vA1e3p5PimuXjTwQybf19aqCh4eHF/Pa41btO/5Zie0WPMpa8PDw8C7x8vD07J58wWjvr98V8PDw8K7y8hb+2eGntpT8AEG7mOHh4eHd4t1tR7XRRnt0oA4v8PDw8L6E107f8yjhLP6IljE8PDy8NV77Yn92fCofmjwILs5E4OHh4Y15Z1PtWTzRPiGPPN4i8fDw8BZ4Z1N5Pq3fPXrVfsbDw8Pb47WtpiSEzUs/iyqKhQEPDw9vjZe/5OfltqHD2ar1n605Hh4e3g/gnZ3nOgPnvx6l1Hh4eHjfyksC2Ta2OOtbRYeu8PDw8BZ4ecvqLERom2ftcYG39eDh4eEt8NoX/nmDf1RKPGR4eHh4C7w/C5axhqTfECwAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = "LiuYang's Blog";
            clearTimeout(titleTime);
        } else {
            document.title = "LiuYang's Blog";
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
